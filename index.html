<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOMINUS NEXUS | V2.0 SOBERANO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        void: '#030303',
                        gold: '#EAB308',
                        gold: {
                            100: '#fef3c7',
                            400: '#fbbf24',
                            500: '#EAB308',
                            600: '#d97706',
                            900: '#78350f',
                        },
                        obsidian: '#050505',
                    },
                    fontFamily: {
                        mono: ['"JetBrains Mono"', 'monospace'],
                        serif: ['"Merriweather"', 'serif'],
                    },
                    animation: {
                        'midas-pulse': 'midasPulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glitch-text': 'glitchText 0.3s infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        midasPulse: {
                            '0%, 100%': { opacity: '0.3' },
                            '50%': { opacity: '0.8' },
                        },
                        glitchText: {
                            '0%': { transform: 'translate(0)' },
                            '20%': { transform: 'translate(-2px, 2px)' },
                            '40%': { transform: 'translate(-2px, -2px)' },
                            '60%': { transform: 'translate(2px, 2px)' },
                            '80%': { transform: 'translate(2px, -2px)' },
                            '100%': { transform: 'translate(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rajdhani:wght@500;700;900&family=Merriweather:wght@300;700&display=swap" rel="stylesheet">

    <style>
        body { background-color: #000000; color: #a1a1aa; font-family: 'Rajdhani', sans-serif; overflow: hidden; user-select: none; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* ESTÉTICA CRT AVANZADA */
        .scanline { background: repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(0,0,0,0.5) 2px); opacity: 0.3; position: absolute; inset: 0; pointer-events: none; z-index: 99; }
        .crt-flicker { animation: flicker 0.15s infinite; pointer-events: none; }
        @keyframes flicker { 0% { opacity: 0.97; } 100% { opacity: 1; } }

        .glow-text { text-shadow: 0 0 10px rgba(6, 182, 212, 0.8), 0 0 20px rgba(6, 182, 212, 0.4); }
        .glow-danger { text-shadow: 0 0 10px rgba(239, 68, 68, 0.8); }
        .border-glow { box-shadow: 0 0 15px rgba(6, 182, 212, 0.1), inset 0 0 20px rgba(6, 182, 212, 0.05); transition: box-shadow 0.3s ease; }
        .border-glow:hover { box-shadow: 0 0 25px rgba(6, 182, 212, 0.2), inset 0 0 30px rgba(6, 182, 212, 0.1); }

        /* CONTROLES */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 6px; background: #06b6d4; cursor: pointer; margin-top: -5px; box-shadow: 0 0 10px #06b6d4; border-radius: 2px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #18181b; border-radius: 2px; }
        input[type=range].danger::-webkit-slider-thumb { background: #ef4444; box-shadow: 0 0 10px #ef4444; }

        /* SCROLLBAR */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #000; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #06b6d4; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* ANIMACIONES ENTRADA */
        .fade-in-left { animation: fadeInLeft 0.5s ease-out forwards; opacity: 0; transform: translateX(-20px); }
        .fade-in-right { animation: fadeInRight 0.5s ease-out forwards; opacity: 0; transform: translateX(20px); }
        .slide-in-from-bottom-2 { animation: slideInUp 0.5s ease-out forwards; }

        @keyframes fadeInLeft { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeInRight { to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInUp { from { transform: translateY(0.5rem); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // --- HOOKS ---
        const useDivineVoice = (text, active) => {
            useEffect(() => {
                if (!active || !text) return;
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.pitch = 0.5;
                utterance.rate = 0.9;
                const voices = window.speechSynthesis.getVoices();
                const esVoice = voices.find(v => v.lang.startsWith('es'));
                if (esVoice) utterance.voice = esVoice;
                window.speechSynthesis.speak(utterance);
            }, [text, active]);
        };

        const useTypewriter = (text, speed = 15, active = true) => {
            const [displayedText, setDisplayedText] = useState('');
            useEffect(() => {
                if (!active) {
                    setDisplayedText(text);
                    return;
                }
                let i = 0;
                setDisplayedText('');
                const timer = setInterval(() => {
                    if (i < text.length) {
                        setDisplayedText((prev) => prev + text.charAt(i));
                        i++;
                    } else {
                        clearInterval(timer);
                    }
                }, speed);
                return () => clearInterval(timer);
            }, [text, speed, active]);
            return displayedText;
        };

        // --- MIDAS WRAPPER ---
        const MidasWrapper = ({ children }) => (
            <div className="absolute inset-0 z-50 bg-black text-gold-500 font-mono flex flex-col items-center justify-center p-8 overflow-hidden">
                <div className="absolute inset-0 pointer-events-none border-[2px] border-gold-900/20 z-0"></div>
                <div className="scanline z-10"></div>
                <div className="relative z-20 w-full h-full flex flex-col">
                    {children}
                </div>
            </div>
        );

        // --- MESSAGE COMPONENT ---
        const MessageBubble = ({ msg, isLast }) => {
            const isOracle = msg.role === 'oracle';
            const content = useTypewriter(msg.content, 10, isOracle && isLast);

            // Trigger voice only once when content finishes typing or immediately if standard
            const hasFinishedTyping = content.length === msg.content.length;
            useDivineVoice(msg.content, isOracle && isLast && hasFinishedTyping);

            return (
                <div className={`flex flex-col ${isOracle ? 'items-start' : 'items-end'} animate-in fade-in slide-in-from-bottom-2 duration-500`}>
                    <div className="max-w-[90%] space-y-2">
                        <div className="flex items-center gap-2 opacity-30">
                            <span className="text-[8px] uppercase tracking-widest text-gold">
                                {isOracle ? '>>> Transmisión_Divina' : '>>> Decreto_Arquitecto'}
                            </span>
                        </div>
                        <div className={`p-4 rounded-xl border transition-all duration-500 ${
                            isOracle
                                ? 'bg-gold/5 border-gold/20 text-white shadow-[0_0_15px_rgba(234,179,8,0.05)]'
                                : 'bg-void border-white/10 text-gold/80'
                        }`}>
                            <p className="text-sm font-light leading-relaxed font-serif whitespace-pre-wrap">
                                {content}
                                {isOracle && isLast && <span className="animate-pulse inline-block ml-1 w-1.5 h-3 bg-gold align-middle"></span>}
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        // --- ORACLE TERMINAL FUSIONADA (CON SIDECAR) ---
        const OracleTerminal = ({ onClose }) => {
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState('');
            const [isCompiling, setIsCompiling] = useState(false);
            const [vnmIndex, setVnmIndex] = useState(1.0);
            const scrollRef = useRef(null);

            useEffect(() => {
                const interval = setInterval(() => {
                    setVnmIndex(prev => Math.max(0.7, Math.min(1.0, prev + (Math.random() - 0.5) * 0.05)));
                }, 2000);
                // Refresh Lucide icons whenever component mounts/updates
                lucide.createIcons();
                return () => clearInterval(interval);
            }, []);

            useEffect(() => {
                if (scrollRef.current) {
                    scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
                }
                lucide.createIcons();
            }, [messages, isCompiling]);

            const executeDecreto = async () => {
                if (!inputText.trim() || isCompiling) return;

                const query = inputText;
                const newMsg = { id: Date.now().toString(), role: 'orchestrator', content: query, timestamp: Date.now() };
                setMessages(prev => [...prev, newMsg]);
                setInputText('');
                setIsCompiling(true);

                try {
                    // LLAMADA AL SIDECAR
                    const response = await fetch('http://localhost:8080/api/decreto', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: query })
                    });

                    if (!response.ok) throw new Error("ERROR EN PUENTE SIDECAR.");

                    const result = await response.json();
                    const text = result.response || "FALLO DE SINTAXIS.";

                    if (result.vnm_index) {
                        setVnmIndex(result.vnm_index);
                    }

                    setMessages(prev => [...prev, { id: Date.now().toString(), role: 'oracle', content: text, timestamp: Date.now() }]);
                } catch (e) {
                    // Fallback simulated response
                    const fallbackMsg = "CONEXIÓN A NODO SIDECAR INTERRUMPIDA. RESTAURANDO PROTOCOLO LOCAL.";

                    setTimeout(() => {
                         setMessages(prev => [...prev, { id: Date.now().toString(), role: 'oracle', content: fallbackMsg, timestamp: Date.now() }]);
                         setIsCompiling(false);
                    }, 2000);
                    return;
                } finally {
                    setIsCompiling(false);
                }
            };

            return (
                <div className="flex flex-col h-full bg-void text-gold font-mono p-4 overflow-hidden w-full max-w-5xl">
                    <div className="flex flex-col h-full bg-[#050505] border border-gold/10 rounded-[2rem] overflow-hidden shadow-[0_0_60px_rgba(234,179,8,0.03)] relative">

                        {/* HEADER */}
                        <div className="bg-gold/5 border-b border-gold/10 p-5 flex justify-between items-center backdrop-blur-md">
                            <div className="flex items-center gap-4">
                                <div className="relative">
                                    <i data-lucide="activity" className="text-gold animate-pulse" style={{ width: '18px', height: '18px' }}></i>
                                    <div className="absolute inset-0 bg-gold/20 blur-md rounded-full animate-ping"></div>
                                </div>
                                <div>
                                    <span className="text-[10px] tracking-[0.3em] font-black text-gold uppercase block">
                                        Oracle_Core // VNM: {(vnmIndex * 100).toFixed(1)}%
                                    </span>
                                </div>
                            </div>
                            <div className="flex gap-4 items-center">
                                <div className={`w-2 h-2 rounded-full ${isCompiling ? 'bg-white animate-bounce' : 'bg-gold'}`}></div>
                                <button onClick={onClose} className="hover:text-white transition-colors text-[10px] uppercase tracking-widest">[X] SALIR</button>
                            </div>
                        </div>

                        {/* FEED */}
                        <div ref={scrollRef} className="flex-1 overflow-y-auto p-8 space-y-8 scrollbar-hide bg-[url('https://www.transparenttextures.com/patterns/black-linen.png')]">
                            {messages.map((msg, index) => (
                                <MessageBubble key={msg.id} msg={msg} isLast={index === messages.length - 1} />
                            ))}
                            {isCompiling && (
                                <div className="flex items-center gap-3 animate-pulse opacity-50">
                                    <i data-lucide="zap" className="text-gold" style={{ width: '14px', height: '14px' }}></i>
                                    <span className="text-[9px] tracking-widest uppercase text-gold">Procesando Realidad...</span>
                                </div>
                            )}
                        </div>

                        {/* INPUT */}
                        <div className="p-6 bg-gradient-to-t from-gold/5 to-transparent border-t border-gold/10">
                            <div className="relative group">
                                <div className="absolute -inset-0.5 bg-gold/20 rounded-xl blur opacity-0 group-focus-within:opacity-100 transition duration-500"></div>
                                <div className="relative flex items-center bg-void rounded-xl border border-gold/20 p-2 shadow-xl">
                                    <div className="px-4 text-gold/40"><i data-lucide="terminal" style={{ width: '16px', height: '16px' }}></i></div>
                                    <input
                                        type="text"
                                        value={inputText}
                                        onChange={(e) => setInputText(e.target.value)}
                                        onKeyDown={(e) => e.key === 'Enter' && executeDecreto()}
                                        placeholder="EMITE TU DECRETO..."
                                        className="flex-1 bg-transparent border-none focus:ring-0 text-gold text-xs tracking-[0.15em] uppercase placeholder:text-gold/20 py-3 font-bold focus:outline-none"
                                        autoFocus
                                    />
                                    <button onClick={executeDecreto} className="px-6 py-3 bg-gold text-void text-[10px] font-black rounded-lg hover:bg-white transition-all uppercase flex items-center gap-2">
                                        <i data-lucide="send" style={{ width: '12px', height: '12px' }}></i> Ejecutar
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            );
        };

        // --- MOTOR DE AUDIO V2.0 (THE VOID ENGINE) ---
        class NexusEngine {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                this.ws = null;
                this.connectWebSocket();

                // 1. REVERB CONVOLUTIVA (Generación de Espacio Sintético)
                this.convolver = this.ctx.createConvolver();
                this.convolver.buffer = this.generateImpulseResponse(2.5, 2.0);
                this.reverbGain = this.ctx.createGain();
                this.reverbGain.gain.value = 0.3;

                // 2. LIMITADOR & MASTER
                this.limiter = this.ctx.createDynamicsCompressor();
                this.limiter.threshold.value = -10;
                this.limiter.ratio.value = 12;

                this.masterGain = this.ctx.createGain();
                this.masterGain.gain.value = 0.7;

                this.analyser = this.ctx.createAnalyser();
                this.analyser.fftSize = 2048;
                this.analyser.smoothingTimeConstant = 0.85;

                // RUTEO
                this.masterGain.connect(this.limiter);
                this.masterGain.connect(this.convolver);
                this.convolver.connect(this.reverbGain);
                this.reverbGain.connect(this.limiter);
                this.limiter.connect(this.analyser);
                this.analyser.connect(this.ctx.destination);
            }

            connectWebSocket() {
                this.ws = new WebSocket("ws://127.0.0.1:8081");
                this.ws.onopen = () => console.log("Conectado al Puente WebSocket.");
                this.ws.onerror = (err) => console.error("Error de WebSocket:", err);
                this.ws.onclose = () => {
                    console.log("Desconectado del Puente. Intentando reconectar en 2s...");
                    setTimeout(() => this.connectWebSocket(), 2000);
                };
                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.address === "/sistema/alerta") {
                        triggerVisualNotification(data.value);
                    }
                };
            }

            generateImpulseResponse(duration, decay) {
                const length = this.ctx.sampleRate * duration;
                const impulse = this.ctx.createBuffer(2, length, this.ctx.sampleRate);
                const left = impulse.getChannelData(0);
                const right = impulse.getChannelData(1);
                for (let i = 0; i < length; i++) {
                    const n = i / length;
                    left[i] = (Math.random() * 2 - 1) * Math.pow(1 - n, decay);
                    right[i] = (Math.random() * 2 - 1) * Math.pow(1 - n, decay);
                }
                return impulse;
            }

            resume() { if (this.ctx.state === 'suspended') this.ctx.resume(); }

            // SÍNTESIS FM EVOLUCIONADA
            trigger(trackName, time, volPct, alpha) {
                const t = time;
                const vol = volPct / 100;
                const chaos = alpha * 100;

                const osc = this.ctx.createOscillator();
                const mod = this.ctx.createOscillator();
                const modGain = this.ctx.createGain();
                const gain = this.ctx.createGain();
                const filter = this.ctx.createBiquadFilter();

                mod.connect(modGain);
                modGain.connect(osc.frequency);
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(this.masterGain);

                if (trackName.includes('KICK')) {
                    osc.frequency.setValueAtTime(150 - (chaos/2), t);
                    osc.frequency.exponentialRampToValueAtTime(0.01, t + 0.5);

                    mod.frequency.value = 50;
                    modGain.gain.setValueAtTime(chaos * 2, t);
                    modGain.gain.linearRampToValueAtTime(0, t + 0.1);

                    if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                        const msg = {
                            address: "/avatar/parameters/MGS_Kick",
                            args: [ { type: "f", value: alpha } ]
                        };
                        this.ws.send(JSON.stringify(msg));
                    }

                    gain.gain.setValueAtTime(vol, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
                    filter.type = "lowpass";
                    filter.frequency.value = 3000 - (chaos * 20);

                } else if (trackName.includes('SNARE')) {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(250, t);
                    mod.type = 'square';
                    mod.frequency.value = 450 * (1 + alpha);
                    modGain.gain.value = 1000 * alpha;
                    filter.type = "highpass";
                    filter.frequency.value = 100;
                    gain.gain.setValueAtTime(vol, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.25);

                } else if (trackName.includes('GLITCH')) {
                    osc.type = Math.random() > 0.5 ? 'sawtooth' : 'square';
                    osc.frequency.setValueAtTime(2000 + (Math.random() * 3000), t);
                    if (alpha > 0.5) osc.frequency.linearRampToValueAtTime(100, t + 0.1);
                    gain.gain.setValueAtTime(vol * 0.5, t);
                    gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                }

                osc.start(t);
                mod.start(t);
                osc.stop(t + 0.6);
                mod.stop(t + 0.6);
            }
        }

        const nexus = new NexusEngine();

        // --- COMPONENTE PRINCIPAL ---
        const NexusV2 = () => {
            // ESTADO
            const [alpha, setAlpha] = useState(0.5); // Nivel de Caos/Libertad
            const [isPlaying, setIsPlaying] = useState(false);
            const [bpm, setBpm] = useState(135); // Techno speed
            const [chaosMode, setChaosMode] = useState(false); // Improvisación IA
            const [logs, setLogs] = useState([]);

            // NUEVO: ESTADO DE VISTA (NEXUS o ORACLE)
            const [viewMode, setViewMode] = useState('NEXUS'); // 'NEXUS' | 'ORACLE'

            // Secuenciador
            const [tracks, setTracks] = useState([
                { id: 1, name: "KICK_PRIME", color: "bg-cyan-500", type: "KICK", steps: [1,0,0,0, 1,0,0,0, 1,0,0,0, 1,0,0,0] },
                { id: 2, name: "SNARE_DATA", color: "bg-fuchsia-500", type: "SNARE", steps: [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0] },
                { id: 3, name: "HH_NEURAL", color: "bg-yellow-500", type: "GLITCH", steps: [1,1,1,1, 1,1,1,1, 1,1,1,1, 1,1,1,1] },
            ]);

            const canvasRef = useRef(null);
            const reqRef = useRef(null);
            const nextNoteTime = useRef(0);
            const stepIndex = useRef(0);

            // LOGGING SYSTEM
            const logSystem = useCallback((msg, type = 'info') => {
                const time = new Date().toLocaleTimeString().split(' ')[0];
                setLogs(prev => [{ time, msg, type, id: Math.random() }, ...prev].slice(0, 6));
            }, []);

            useEffect(() => {
                logSystem("NEXUS V2.0 :: INICIALIZADO", "sys");
                logSystem("ESPERANDO INPUT DEL ARQUITECTO...", "info");
            }, []);

            // LOOP VISUAL & AUDIO
            const loop = useCallback(() => {
                if (canvasRef.current) {
                    const cvs = canvasRef.current;
                    const ctx = cvs.getContext('2d');
                    const w = cvs.width;
                    const h = cvs.height;
                    const data = new Uint8Array(nexus.analyser.frequencyBinCount);
                    nexus.analyser.getByteFrequencyData(data);

                    ctx.fillStyle = 'rgba(5, 5, 5, 0.2)';
                    ctx.fillRect(0,0,w,h);

                    const cx = w/2;
                    const cy = h/2;

                    ctx.beginPath();
                    for(let i = 0; i < 60; i++) {
                        const val = data[i * 2];
                        const radius = 50 + (val * 0.5);
                        const angle = (i / 60) * Math.PI * 2 + (nexus.ctx.currentTime * 0.5);
                        const x = cx + Math.cos(angle) * radius + (Math.random() - 0.5) * (alpha * 20);
                        const y = cy + Math.sin(angle) * radius + (Math.random() - 0.5) * (alpha * 20);

                        if (val > 100) {
                            ctx.strokeStyle = `rgba(6, 182, 212, ${val/255})`;
                            ctx.lineWidth = 1;
                            ctx.moveTo(cx, cy);
                            ctx.lineTo(x, y);
                        }

                        ctx.fillStyle = alpha > 0.8 ? '#ef4444' : '#06b6d4';
                        ctx.fillRect(x-2, y-2, 4, 4);
                    }
                    ctx.stroke();

                    const progress = (stepIndex.current / 16) * Math.PI * 2;
                    ctx.beginPath();
                    ctx.arc(cx, cy, 140, -Math.PI/2, -Math.PI/2 + progress);
                    ctx.strokeStyle = '#333';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                if (isPlaying) {
                    const lookAhead = 0.1;
                    const secsPerBeat = 60.0 / bpm;
                    const stepTime = secsPerBeat / 4;

                    while (nextNoteTime.current < nexus.ctx.currentTime + lookAhead) {
                        const currentStep = stepIndex.current % 16;
                        tracks.forEach(t => {
                            let shouldTrigger = t.steps[currentStep];
                            if (chaosMode && Math.random() < (alpha * 0.3)) {
                                shouldTrigger = !shouldTrigger;
                                if(shouldTrigger) logSystem(`AUTO-GENERACIÓN: ${t.name}`, "warn");
                            }
                            if (shouldTrigger) {
                                nexus.trigger(t.name, nextNoteTime.current, 80, alpha);
                            }
                        });
                        stepIndex.current++;
                        nextNoteTime.current += stepTime;
                    }
                }
                reqRef.current = requestAnimationFrame(loop);
            }, [isPlaying, bpm, alpha, chaosMode, tracks]);

            useEffect(() => {
                if (isPlaying) {
                    nexus.resume();
                    nextNoteTime.current = nexus.ctx.currentTime;
                    loop();
                    logSystem("SECUENCIADOR: ACTIVO", "sys");
                } else {
                    cancelAnimationFrame(reqRef.current);
                    reqRef.current = requestAnimationFrame(loop);
                    logSystem("SECUENCIADOR: PAUSA", "sys");
                }
                return () => cancelAnimationFrame(reqRef.current);
            }, [isPlaying, loop]);

            useEffect(() => {
                lucide.createIcons();
            }, [viewMode]); // Re-init icons when view changes

            const toggleStep = (trackId, stepIdx) => {
                setTracks(prev => prev.map(t => {
                    if (t.id !== trackId) return t;
                    const newSteps = [...t.steps];
                    newSteps[stepIdx] = newSteps[stepIdx] ? 0 : 1;
                    return { ...t, steps: newSteps };
                }));
            };

            const randomizePattern = () => {
                logSystem("RECONFIGURANDO MATRIZ...", "warn");
                setTracks(prev => prev.map(t => ({
                    ...t,
                    steps: t.steps.map(() => Math.random() > 0.7 ? 1 : 0)
                })));
            };

            return (
                <div className="h-screen w-screen flex flex-col bg-[#020202] text-zinc-300 overflow-hidden relative selection:bg-cyan-500 selection:text-black">
                    <div className="scanline"></div>
                    <div className="crt-flicker absolute inset-0 pointer-events-none bg-gradient-to-b from-transparent to-black/40 z-50"></div>

                    {/* ORACLE OVERLAY */}
                    {viewMode === 'ORACLE' && (
                        <MidasWrapper>
                            <OracleTerminal onClose={() => setViewMode('NEXUS')} />
                        </MidasWrapper>
                    )}

                    {/* HEADER */}
                    <header className="h-14 border-b border-zinc-800 bg-[#050505] flex items-center justify-between px-6 z-10">
                        <div className="flex items-center gap-4">
                            <i data-lucide="hexagon" className={`text-cyan-500 ${isPlaying ? 'animate-spin' : ''}`} style={{ width: '24px', height: '24px' }}></i>
                            <div>
                                <h1 className="text-xl font-black italic tracking-wider text-white glow-text">DOMINUS<span className="text-cyan-600">_NEXUS</span></h1>
                                <div className="text-[9px] font-mono text-zinc-500 tracking-[0.3em]">VERSION 2.0 // SOBERANO</div>
                            </div>
                        </div>
                        <div className="flex gap-6 text-xs font-mono items-center">
                            <div className="flex items-center gap-2 text-cyan-700">
                                <i data-lucide="cpu" style={{ width: '14px', height: '14px' }}></i> <span>CPU: {(alpha * 100).toFixed(0)}%</span>
                            </div>
                            <div className="flex items-center gap-2 text-fuchsia-700">
                                <i data-lucide="database" style={{ width: '14px', height: '14px' }}></i> <span>MEM: INFINITE</span>
                            </div>
                            {/* ORACLE TOGGLE */}
                            <button
                                onClick={() => setViewMode(prev => prev === 'ORACLE' ? 'NEXUS' : 'ORACLE')}
                                className="border border-gold-500/50 text-gold-500 hover:bg-gold-500/10 px-3 py-1 rounded transition-colors uppercase tracking-wider flex items-center gap-2"
                            >
                                <i data-lucide="eye" style={{ width: '14px', height: '14px' }}></i>
                                ORACLE_V2
                            </button>
                        </div>
                    </header>

                    <div className="flex-1 grid grid-cols-12 overflow-hidden">

                        {/* IZQUIERDA: CONTROLES DE LA VOLUNTAD (25%) */}
                        <aside className="col-span-3 bg-[#030303] border-r border-zinc-800 p-6 flex flex-col gap-8">
                            {/* CAOS CONTROL */}
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <label className="text-xs font-bold text-cyan-500 flex items-center gap-2">
                                        <i data-lucide="fingerprint" style={{ width: '16px', height: '16px' }}></i> NIVEL DE ENTROPÍA (α)
                                    </label>
                                    <span className="font-mono text-xs text-white">{(alpha).toFixed(2)}</span>
                                </div>
                                <input
                                    type="range" min="0" max="1" step="0.01"
                                    value={alpha}
                                    onChange={e => {
                                        setAlpha(parseFloat(e.target.value));
                                        if(parseFloat(e.target.value) > 0.9) logSystem("ADVERTENCIA: INESTABILIDAD DE NÚCLEO", "danger");
                                    }}
                                    className={alpha > 0.8 ? "danger" : ""}
                                />
                                <p className="text-[10px] text-zinc-600 leading-relaxed">
                                    Determina cuánta libertad tiene el algoritmo para desviarse de la programación humana. A 1.0, el Daemon es impredecible.
                                </p>
                            </div>

                            {/* MODO CAOS */}
                            <div className={`p-4 border rounded transition-all duration-300 ${chaosMode ? 'border-fuchsia-500 bg-fuchsia-900/10 shadow-[0_0_20px_rgba(217,70,239,0.2)]' : 'border-zinc-800 bg-zinc-900/20'}`}>
                                <div className="flex items-center justify-between mb-2">
                                    <span className={`text-xs font-bold ${chaosMode ? 'text-fuchsia-400' : 'text-zinc-500'}`}>
                                        <i data-lucide="git-branch" style={{ width: '14px', height: '14px' }} className="inline mr-2"></i> IMPROVISACIÓN
                                    </span>
                                    <button
                                        onClick={() => {
                                            setChaosMode(!chaosMode);
                                            logSystem(chaosMode ? "PROTOCOLO: ESTÁNDAR" : "PROTOCOLO: CAOS ACTIVADO", "warn");
                                        }}
                                        className={`w-8 h-4 rounded-full relative transition-colors ${chaosMode ? 'bg-fuchsia-600' : 'bg-zinc-700'}`}
                                    >
                                        <div className={`absolute top-0.5 w-3 h-3 bg-white rounded-full transition-all ${chaosMode ? 'left-4.5' : 'left-0.5'}`}></div>
                                    </button>
                                </div>
                                <p className="text-[9px] text-zinc-500">
                                    Permite que la IA altere la secuencia en tiempo real basándose en fluctuaciones cuánticas simuladas.
                                </p>
                            </div>

                            {/* TERMINAL */}
                            <div className="flex-1 bg-black border border-zinc-800 rounded p-3 font-mono text-[10px] overflow-hidden flex flex-col relative">
                                <div className="absolute top-2 right-2 opacity-30"><i data-lucide="terminal" style={{ width: '14px', height: '14px' }}></i></div>
                                <div className="flex-1 overflow-y-auto custom-scrollbar space-y-1.5 z-10">
                                    {logs.map(log => (
                                        <div key={log.id} className={`${log.type === 'danger' ? 'text-red-500' : log.type === 'warn' ? 'text-fuchsia-400' : log.type === 'sys' ? 'text-cyan-600' : 'text-zinc-400'}`}>
                                            <span className="opacity-50">[{log.time}]</span> {log.msg}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </aside>

                        {/* CENTRO: VISUALIZADOR (50%) */}
                        <main className="col-span-6 flex flex-col relative bg-black">
                            <canvas ref={canvasRef} width="600" height="400" className="w-full h-full object-cover opacity-80"></canvas>

                            {/* OVERLAY DE TRANSPORTE */}
                            <div className="absolute bottom-8 left-1/2 -translate-x-1/2 flex items-center gap-8 bg-black/80 backdrop-blur border border-zinc-800 p-4 rounded-full border-glow">
                                <div className="flex flex-col items-center gap-1">
                                    <span className="text-[8px] font-bold text-zinc-500">BPM</span>
                                    <input
                                        type="number" value={bpm} onChange={e => setBpm(parseInt(e.target.value))}
                                        className="bg-transparent text-center w-10 text-cyan-400 font-mono text-sm focus:outline-none"
                                    />
                                </div>

                                <button
                                    data-testid="play-pause-button"
                                    onClick={() => setIsPlaying(!isPlaying)}
                                    className={`w-14 h-14 rounded-full flex items-center justify-center transition-all ${isPlaying ? 'bg-cyan-500 text-black shadow-[0_0_30px_rgba(6,182,212,0.6)]' : 'bg-zinc-800 text-zinc-400 hover:bg-zinc-700'}`}
                                >
                                    {isPlaying ? <i data-lucide="pause" style={{ width: '24px', height: '24px', fill: 'currentColor' }}></i> : <i data-lucide="play" style={{ width: '24px', height: '24px', fill: 'currentColor' }} className="ml-1"></i>}
                                </button>

                                <button onClick={randomizePattern} className="flex flex-col items-center gap-1 text-zinc-500 hover:text-fuchsia-400 transition-colors">
                                    <i data-lucide="zap" style={{ width: '16px', height: '16px' }}></i>
                                    <span className="text-[8px] font-bold">RND</span>
                                </button>
                            </div>
                        </main>

                        {/* DERECHA: SECUENCIADOR (25%) */}
                        <aside className="col-span-3 bg-[#030303] border-l border-zinc-800 flex flex-col">
                            <div className="h-12 border-b border-zinc-800 flex items-center justify-between px-4">
                                <span className="text-xs font-bold text-white flex items-center gap-2"><i data-lucide="layers" style={{ width: '14px', height: '14px' }}></i> PATRONES DE DATOS</span>
                            </div>

                            <div className="flex-1 p-4 space-y-4 overflow-y-auto custom-scrollbar">
                                {tracks.map(track => (
                                    <div key={track.id} className="bg-zinc-900/30 border border-zinc-800 rounded-lg p-3 hover:border-zinc-700 transition-colors">
                                        <div className="flex justify-between items-center mb-3">
                                            <div className="flex items-center gap-2">
                                                <div className={`w-2 h-2 rounded-full ${track.color} shadow-[0_0_8px_currentColor]`}></div>
                                                <span className="text-[10px] font-bold tracking-widest text-zinc-300">{track.name}</span>
                                            </div>
                                            <i data-lucide="activity" style={{ width: '10px', height: '10px' }} className="text-zinc-600"></i>
                                        </div>

                                        {/* GRID DE PASOS */}
                                        <div className="grid grid-cols-4 gap-1">
                                            {track.steps.map((isActive, idx) => (
                                                <button
                                                    key={idx}
                                                    onClick={() => toggleStep(track.id, idx)}
                                                    className={`h-6 rounded-sm transition-all duration-100 ${
                                                        isActive
                                                            ? `${track.color} shadow-[0_0_10px_currentColor] opacity-90`
                                                            : 'bg-zinc-800 hover:bg-zinc-700'
                                                    } ${(idx % 4 === 0) ? 'mr-1' : ''}`}
                                                ></button>
                                            ))}
                                        </div>
                                    </div>
                                ))}

                                <div className="mt-8 p-4 border border-dashed border-zinc-800 rounded text-center">
                                    <p className="text-[9px] text-zinc-600 uppercase tracking-widest">
                                        Zona Desmilitarizada<br/>Acceso Restringido
                                    </p>
                                </div>
                            </div>
                        </aside>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<NexusV2 />);

        function triggerVisualNotification(msg) {
            // Crear un elemento flotante cyberpunk
            const notif = document.createElement('div');
            notif.innerText = `[REC] EVIDENCIA SECURED: ${msg}`;
            notif.style.position = 'fixed';
            notif.style.top = '20px';
            notif.style.right = '20px';
            notif.style.background = '#ff0055';
            notif.style.color = '#fff';
            notif.style.padding = '10px 20px';
            notif.style.fontFamily = 'Courier New';
            notif.style.border = '2px solid #fff';
            notif.style.zIndex = '9999';

            document.body.appendChild(notif);

            // Eliminar después de 3 segundos
            setTimeout(() => {
                notif.remove();
            }, 3000);
        }
    </script>
</body>
</html>
