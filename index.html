<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMEGA DAW: AUTO-PILOT | LIMITER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #050505; color: #a1a1aa; font-family: 'Rajdhani', sans-serif; overflow: hidden; user-select: none; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* UI DEL LIMITADOR */
        .limiter-led {
            width: 8px; height: 8px; border-radius: 50%; background: #333;
            transition: background 0.05s;
            box-shadow: 0 0 2px rgba(0,0,0,0.5) inset;
        }
        .limiter-led.active { background: #ef4444; box-shadow: 0 0 8px #ef4444; }
        .limiter-led.warn { background: #eab308; box-shadow: 0 0 8px #eab308; }

        /* KNOB AUTOMATIZADO */
        .knob-container { position: relative; width: 40px; height: 40px; }
        .knob-ring {
            width: 100%; height: 100%; border-radius: 50%; border: 2px solid #333;
            border-top-color: #06b6d4; transform: rotate(-135deg); transition: transform 0.1s linear;
        }
        .knob-ghost {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%;
            border: 2px dashed rgba(6, 182, 212, 0.3); pointer-events: none;
        }

        /* SCANLINES */
        .scanline { background: repeating-linear-gradient(0deg, transparent, transparent 2px, #000 3px); opacity: 0.3; position: absolute; inset: 0; pointer-events: none; z-index: 50; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- MOTOR DE AUDIO (CON LIMITADOR Y LFO) ---
        class AudioEngine {
            constructor() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();

                // 1. CADENA MASTER DE SEGURIDAD (The Safety Net)
                this.masterLimiter = this.ctx.createDynamicsCompressor();
                this.masterLimiter.threshold.value = -3;  // Empieza a comprimir a -3dB
                this.masterLimiter.knee.value = 30;       // Curva suave
                this.masterLimiter.ratio.value = 12;      // Compresión fuerte (Limitador)
                this.masterLimiter.attack.value = 0.003;  // Reacción rápida
                this.masterLimiter.release.value = 0.25;  // Recuperación musical

                this.masterGain = this.ctx.createGain();
                this.masterGain.gain.value = 0.8; // Headroom

                this.analyser = this.ctx.createAnalyser();
                this.analyser.fftSize = 1024;

                // Ruteo: Gain -> Limiter -> Analyser -> Speakers
                this.masterGain.connect(this.masterLimiter);
                this.masterLimiter.connect(this.analyser);
                this.analyser.connect(this.ctx.destination);

                // 2. AUTOMATIZACIÓN (The Ghost Hand)
                // LFO Global para filtros
                this.lfo = this.ctx.createOscillator();
                this.lfo.frequency.value = 0.2; // 0.2 Hz (Muy lento, ciclo de 5 segundos)
                this.lfoGain = this.ctx.createGain();
                this.lfoGain.gain.value = 500; // Profundidad de la modulación (500Hz arriba/abajo)

                this.lfo.connect(this.lfoGain);
                this.lfo.start();

                this.noiseBuffer = this.createNoiseBuffer();
            }

            createNoiseBuffer() {
                const b = this.ctx.createBuffer(1, this.ctx.sampleRate * 2, this.ctx.sampleRate);
                const d = b.getChannelData(0);
                for(let i=0; i<d.length; i++) d[i] = Math.random() * 2 - 1;
                return b;
            }

            resume() { if (this.ctx.state === 'suspended') this.ctx.resume(); }

            // Trigger inteligente
            trigger(trackName, time, volPct) {
                const t = time;
                const vol = volPct / 100;

                // TRACK: KICK (El pulso)
                if (trackName.includes('KICK')) {
                    const osc = this.ctx.createOscillator();
                    const g = this.ctx.createGain();

                    osc.frequency.setValueAtTime(150, t);
                    osc.frequency.exponentialRampToValueAtTime(40, t + 0.5);

                    g.gain.setValueAtTime(vol, t);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.5);

                    osc.connect(g);
                    g.connect(this.masterGain);
                    osc.start(t); osc.stop(t + 0.5);
                }

                // TRACK: BASS (El que sufre la automatización)
                else if (trackName.includes('BASS')) {
                    const osc = this.ctx.createOscillator();
                    const filter = this.ctx.createBiquadFilter(); // Filtro resonante
                    const g = this.ctx.createGain();

                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(65, t); // Nota fija (Drone)

                    // CONFIGURACIÓN DEL FILTRO
                    filter.type = 'lowpass';
                    filter.Q.value = 15; // Mucha resonancia (Acid)
                    filter.frequency.setValueAtTime(400, t); // Frecuencia base

                    // CONECTAR LA MANO FANTASMA (LFO -> FILTER)
                    this.lfoGain.connect(filter.frequency);

                    // Envolvente de volumen
                    g.gain.setValueAtTime(0, t);
                    g.gain.linearRampToValueAtTime(vol, t + 0.05);
                    g.gain.setValueAtTime(vol * 0.8, t + 0.2);
                    g.gain.linearRampToValueAtTime(0, t + 0.5);

                    osc.connect(filter);
                    filter.connect(g);
                    g.connect(this.masterGain);

                    osc.start(t); osc.stop(t + 0.6);

                    // IMPORTANTE: Desconectar el LFO después para no acumular conexiones
                    // (En una app real, esto se maneja con nodos permanentes,
                    // aquí usamos un hack de timeout para limpieza simple)
                    setTimeout(() => {
                        try { this.lfoGain.disconnect(filter.frequency); } catch(e){}
                    }, 600);
                }

                // TRACK: HIHATS
                else if (trackName.includes('HI')) {
                    const src = this.ctx.createBufferSource();
                    src.buffer = this.noiseBuffer;
                    const f = this.ctx.createBiquadFilter();
                    f.type = 'highpass'; f.frequency.value = 7000;
                    const g = this.ctx.createGain();
                    g.gain.setValueAtTime(vol*0.6, t);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
                    src.connect(f); f.connect(g); g.connect(this.masterGain);
                    src.start(t); src.stop(t+0.1);
                }
            }
        }

        const engine = new AudioEngine();

        const OmegaAuto = () => {
            const [isPlaying, setIsPlaying] = useState(false);
            const [bpm, setBpm] = useState(130);
            const [currentTime, setCurrentTime] = useState(0);
            const [reduction, setReduction] = useState(0); // Para el medidor del limitador
            const [lfoValue, setLfoValue] = useState(0);   // Para el knob fantasma visual

            // Datos de pistas
            const tracks = [
                { id: 1, name: "KICK_MAIN", color: "bg-red-600", regions: [{s:0,w:40}, {s:160,w:40}, {s:320,w:40}, {s:480,w:40}], vol: 90 },
                { id: 2, name: "BASS_AUTO", color: "bg-cyan-500", regions: [{s:0,w:160}, {s:160,w:160}, {s:320,w:160}, {s:480,w:160}], vol: 80 },
                { id: 3, name: "HI_HATS", color: "bg-yellow-500", regions: Array.from({length:16},(_,i)=>({s:i*40,w:10})), vol: 50 }
            ];

            const reqRef = useRef();
            const nextNoteTime = useRef(0);

            // BUCLE DE UI (60FPS)
            const animate = () => {
                // 1. Simular movimiento del LFO para la UI
                // (0.2 Hz = periodo de 5000ms)
                const time = Date.now();
                const angle = Math.sin(time * 0.0012) * 135; // Oscila entre -135 y +135 grados
                setLfoValue(angle);

                // 2. Leer reducción del compresor (Simulado visualmente basado en amplitud)
                if(isPlaying) {
                     const data = new Uint8Array(engine.analyser.frequencyBinCount);
                     engine.analyser.getByteTimeDomainData(data);
                     let max = 0;
                     for(let i=0; i<data.length; i++) {
                         const v = Math.abs(data[i] - 128);
                         if(v > max) max = v;
                     }
                     // Si la amplitud es muy alta, mostramos "reducción"
                     setReduction(max > 80 ? Math.min((max-80), 5) : 0);
                } else {
                    setReduction(0);
                }

                if(isPlaying) {
                    const pxPerSec = (40 / (60/bpm));
                    setCurrentTime((engine.ctx.currentTime * pxPerSec) % 640);
                    reqRef.current = requestAnimationFrame(animate);
                }
            };

            // SCHEDULER DE AUDIO
            const schedule = useCallback(() => {
                const lookAhead = 0.1;
                const secsPerBeat = 60.0 / bpm;
                const pxPerBeat = 40;
                const pxPerSec = pxPerBeat / secsPerBeat;

                while (nextNoteTime.current < engine.ctx.currentTime + lookAhead) {
                    const beatDur = 0.25 * secsPerBeat;
                    // Lógica de disparo
                    const cycleTime = (nextNoteTime.current * pxPerSec) % 640; // Loop de 16 beats (640px)

                    tracks.forEach(t => {
                        t.regions.forEach(r => {
                            // Check overlap simple para demo
                            if (cycleTime >= r.s && cycleTime < r.s + 10) { // Tolerancia
                                engine.trigger(t.name, nextNoteTime.current, t.vol);
                            }
                        });
                    });
                    nextNoteTime.current += beatDur;
                }
                if(isPlaying) setTimeout(schedule, 25);
            }, [isPlaying, bpm]);

            useEffect(() => {
                if(isPlaying) {
                    engine.resume();
                    nextNoteTime.current = engine.ctx.currentTime;
                    schedule();
                    animate();
                } else {
                    cancelAnimationFrame(reqRef.current);
                }
            }, [isPlaying]);

            useEffect(() => {
                lucide.createIcons();
            }, []);

            return (
                <div className="h-screen flex flex-col bg-black overflow-hidden relative">
                    <div className="scanline"></div>

                    {/* HEADER PRO */}
                    <header className="h-24 bg-[#080808] border-b border-zinc-800 flex items-center justify-between px-6 z-10">
                        <div>
                            <h1 className="text-2xl font-black text-white tracking-widest italic">OMEGA<span className="text-cyan-500">_AUTO</span></h1>
                            <div className="text-[10px] text-zinc-500 font-mono flex items-center gap-2">
                                <i data-lucide="shield-check" className="text-green-500" style={{ width: '10px', height: '10px' }}></i>
                                <span>LIMITER PROTECTION: ACTIVE</span>
                            </div>
                        </div>

                        {/* RACK DE EFECTOS AUTOMATIZADOS */}
                        <div className="flex gap-8 bg-[#111] p-2 rounded-lg border border-zinc-800 shadow-xl">

                            {/* LIMITER METER */}
                            <div className="flex flex-col items-center gap-1">
                                <span className="text-[9px] font-bold text-zinc-500">GAIN REDUCTION</span>
                                <div className="flex gap-1">
                                    {[5,4,3,2,1].map(n => (
                                        <div key={n} className={`limiter-led ${reduction >= n ? (n>3?'active':'warn') : ''}`}></div>
                                    ))}
                                </div>
                                <span className="text-[9px] text-zinc-600 font-mono">COMPRESSOR</span>
                            </div>

                            <div className="w-px bg-zinc-800"></div>

                            {/* AUTO-KNOB (LFO) */}
                            <div className="flex flex-col items-center gap-1">
                                <span className="text-[9px] font-bold text-cyan-600 animate-pulse">AUTO-FILTER</span>
                                <div className="knob-container">
                                    {/* El knob que se mueve solo */}
                                    <div className="knob-ghost" style={{ transform: `rotate(${lfoValue}deg)` }}></div>
                                    <div className="knob-ring" style={{ transform: `rotate(${lfoValue}deg)`, borderColor: isPlaying ? '#06b6d4' : '#333' }}></div>
                                </div>
                                <span className="text-[9px] text-zinc-600 font-mono">LFO: 0.2Hz</span>
                            </div>
                        </div>

                        {/* TRANSPORT */}
                        <div className="flex items-center gap-4">
                            <button data-testid="play-pause-button" onClick={() => setIsPlaying(!isPlaying)} className={`w-14 h-14 rounded-full flex items-center justify-center transition-all ${isPlaying ? 'bg-red-600 shadow-[0_0_30px_#dc2626]' : 'bg-zinc-800 hover:bg-zinc-700'}`}>
                                {isPlaying ? <i data-lucide="pause" style={{ fill: 'white' }}></i> : <i data-lucide="play" style={{ fill: 'white', marginLeft: '4px' }}></i>}
                            </button>
                        </div>
                    </header>

                    {/* TIMELINE */}
                    <div className="flex-1 bg-[#030303] relative overflow-hidden flex flex-col justify-center">
                        <div className="absolute inset-0 opacity-10" style={{backgroundImage: 'linear-gradient(90deg, #222 1px, transparent 1px)', backgroundSize: '40px 100%'}}></div>

                        {/* PLAYHEAD */}
                        <div className="absolute top-0 bottom-0 w-0.5 bg-red-500 z-50 shadow-[0_0_15px_red]" style={{ left: currentTime }}></div>

                        {tracks.map(t => (
                            <div key={t.id} className="h-32 border-b border-zinc-900 flex items-center relative group">
                                <div className="w-48 bg-black/50 border-r border-zinc-800 h-full flex flex-col justify-center p-4 z-10 backdrop-blur-sm">
                                    <span className="font-bold text-zinc-300 tracking-wider">{t.name}</span>
                                    {t.name.includes('BASS') && (
                                        <span className="text-[9px] text-cyan-500 flex items-center gap-1 mt-1">
                                            <i data-lucide="gauge" style={{ width: '10px', height: '10px' }}></i> LFO LINKED
                                        </span>
                                    )}
                                </div>
                                <div className="flex-1 relative h-full">
                                    {t.regions.map((r,i) => (
                                        <div key={i} className={`absolute top-4 bottom-4 rounded ${t.color} opacity-40 border border-white/20`}
                                             style={{ left: r.s, width: r.w }}>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<OmegaAuto />);
    </script>
</body>
</html>
