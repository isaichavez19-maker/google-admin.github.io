<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMEGA DAW v3.0 | DAEMON CORE ACTIVE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #030303; color: #e5e5e5; font-family: 'Rajdhani', sans-serif; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 3px; }
        .timeline-grid { background-image: linear-gradient(to right, #18181b 1px, transparent 1px), linear-gradient(to bottom, #18181b 1px, transparent 1px); background-size: 40px 100%; }
        .playhead { box-shadow: 0 0 15px rgba(239, 68, 68, 0.6); }
        .fader-track { -webkit-appearance: none; width: 100%; height: 4px; background: #27272a; border-radius: 2px; outline: none; }
        .fader-track::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 24px; background: #d4d4d8; cursor: pointer; box-shadow: 0 0 10px rgba(255,255,255,0.3); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;

        // --- NÚCLEO 1: CONTEXTO DE AUDIO Y SINTE PROPIO ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();
        const masterGain = ctx.createGain();
        masterGain.connect(ctx.destination);

        // Síntesis interna simple para KICK, SNARE, HIHAT
        const playSynth = (trackName, time, volume) => {
            const gain = ctx.createGain();
            gain.gain.setValueAtTime(volume / 100, time);
            gain.connect(masterGain);

            if (trackName.includes('KICK')) {
                const osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(150, time);
                osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.3);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.5);
                osc.connect(gain);
                osc.start(time);
                osc.stop(time + 0.5);
            } else if (trackName.includes('SNARE')) {
                const osc = ctx.createOscillator();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(220, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
                osc.connect(gain);
                osc.start(time);
                osc.stop(time + 0.2);
            } else if (trackName.includes('HI_HATS')) {
                const osc = ctx.createOscillator();
                osc.type = 'square';
                osc.frequency.setValueAtTime(1000, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
                osc.connect(gain);
                osc.start(time);
                osc.stop(time + 0.05);
            }
        };

        const INITIAL_TRACKS = [
            { id: 1, name: "KICK_DMZ", color: "bg-red-500", regions: [{ start: 0, width: 40, duration: 0.5 }, { start: 160, width: 40, duration: 0.5 }, { start: 320, width: 40, duration: 0.5 }], muted: false, solo: false, vol: 80 },
            { id: 2, name: "SNARE_SYNTH", color: "bg-orange-500", regions: [{ start: 80, width: 40, duration: 0.2 }, { start: 240, width: 40, duration: 0.2 }], muted: false, solo: false, vol: 75 },
            { id: 3, name: "HI_HATS_SEQ", color: "bg-yellow-500", regions: [{ start: 0, width: 800, duration: 0.05 }], muted: false, solo: false, vol: 60 },
            { id: 4, name: "BASS_LINE", color: "bg-blue-500", regions: [{ start: 0, width: 160, duration: 0.8 }, { start: 320, width: 320, duration: 1.2 }], muted: false, solo: false, vol: 90 },
        ];

        const OmegaDAW = () => {
            const [isPlaying, setIsPlaying] = useState(false);
            const [bpm, setBpm] = useState(128);
            const [currentTime, setCurrentTime] = useState(0); // Pixels
            const [tracks, setTracks] = useState(INITIAL_TRACKS);
            const playheadRef = useRef(0);
            const nextNoteTime = useRef(0);
            const lookAhead = 0.1; // 100ms de lookahead para latencia cuántica

            // --- NÚCLEO 2: SINCRONIZACIÓN CUÁNTICA (Scheduler) ---
            const schedule = useCallback(() => {
                if (!isPlaying) return;

                while (nextNoteTime.current < ctx.currentTime + lookAhead) {
                    const secondsPerBeat = 60.0 / bpm;
                    const secondsPer16th = 0.25 * secondsPerBeat;

                    // Convertir currentTime visual (pixels) a tiempo real (seconds)
                    // Asumimos 40px = 1/16 note para esta escala visual (minWidth: 1200px = 30 beats)
                    const pixelsPerSecond = 1200 / (secondsPerBeat * 30);

                    // Iterar pistas y regiones para disparo sónico
                    tracks.forEach(track => {
                        if (track.muted || (tracks.some(t => t.solo) && !track.solo)) return;

                        track.regions.forEach(region => {
                            const regionStartSeconds = region.start / pixelsPerSecond;

                            // Lógica de disparo simple (requiere un scheduler más complejo para producción real)
                            if (nextNoteTime.current >= regionStartSeconds && nextNoteTime.current <= regionStartSeconds + secondsPer16th) {
                                playSynth(track.name, nextNoteTime.current, track.vol);
                            }
                        });
                    });

                    nextNoteTime.current += secondsPer16th;
                }

                // Actualización visual desacoplada (para evitar latencia visual)
                const visualTime = (ctx.currentTime / (60.0 / bpm)) * 40; // Convertir segundos a pixels visuales (40px por beat approx)
                playheadRef.current = visualTime % 1200; // Loop visual
                setCurrentTime(playheadRef.current);

                requestAnimationFrame(schedule);
            }, [isPlaying, bpm, tracks]);

            useEffect(() => {
                if (isPlaying) {
                    ctx.resume();
                    nextNoteTime.current = ctx.currentTime;
                    requestAnimationFrame(schedule);
                } else {
                    cancelAnimationFrame(schedule);
                }
            }, [isPlaying, schedule]);

            const togglePlay = () => {
                setIsPlaying(!isPlaying);
            };

            useEffect(() => {
                lucide.createIcons();
        }, []);

            // --- NÚCLEO 3: MEZCLADOR Y ESTADO ---
            const toggleMute = (id) => { setTracks(tracks.map(t => t.id === id ? { ...t, muted: !t.muted } : t)); };
            const toggleSolo = (id) => { setTracks(tracks.map(t => { if (t.id === id) return { ...t, solo: !t.solo }; return { ...t, solo: false }; })); };
            const updateVol = (id, val) => { setTracks(tracks.map(t => t.id === id ? { ...t, vol: val } : t)); };

            return (
                <div className="flex flex-col h-screen bg-black text-zinc-300">
                    {/* 1. HEADER / TRANSPORT BAR */}
                    <header className="h-16 bg-zinc-900 border-b border-zinc-800 flex items-center justify-between px-6 z-20">
                        <div className="flex items-center gap-6">
                            <div className="flex flex-col">
                                <h1 className="text-xl font-bold tracking-widest text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600">OMEGA<span className="text-white">_DAW</span></h1>
                                <span className="text-[10px] text-zinc-500 font-mono tracking-tighter">CORE ACTIVE v3.0</span>
                            </div>
                            <div className="bg-black border border-zinc-700 rounded px-4 py-1 font-mono text-cyan-400 flex gap-4">
                                <div><span className="text-zinc-600 text-[10px] block">BPM</span><span className="text-xl font-bold">{bpm}</span></div>
                                <div><span className="text-zinc-600 text-[10px] block">TIME</span><span className="text-xl font-bold">{(ctx.currentTime).toFixed(3)}s</span></div>
                            </div>
                        </div>
                        <div className="flex items-center gap-2">
                            <button data-testid="play-pause-button" onClick={togglePlay} className={`p-4 rounded-full transition-all duration-200 ${isPlaying ? 'bg-red-500 text-white shadow-[0_0_20px_rgba(239,68,68,0.5)]' : 'bg-cyan-600 text-white hover:bg-cyan-500'}`}>
                                {isPlaying ? <i data-lucide="pause" style={{ fill: 'currentColor' }}></i> : <i data-lucide="play" style={{ fill: 'currentColor', marginLeft: '4px' }}></i>}
                            </button>
                            <button data-testid="stop-button" onClick={() => { setIsPlaying(false); setCurrentTime(0); playheadRef.current = 0; }} className="p-3 rounded-full hover:bg-zinc-800 text-zinc-400"><i data-lucide="square" style={{ fill: 'currentColor' }}></i></button>
                        </div>
                         <div className="flex items-center gap-4 text-xs font-mono text-zinc-500">
                            <div className="flex items-center gap-2"><i data-lucide="cpu"></i><span>CPU: {((playheadRef.current % 100)/10).toFixed(1)}%</span></div>
                            <div className="flex items-center gap-2"><i data-lucide="activity"></i><span>SYNTH: ACTIVE</span></div>
                        </div>
                    </header>

                    {/* 2. AREA DE TRABAJO */}
                    <div className="flex-1 flex overflow-hidden">
                        <div className="w-80 bg-zinc-900 border-r border-zinc-800 flex flex-col z-10 overflow-y-auto">
                            <div className="p-2 border-b border-zinc-800 bg-zinc-900/90 sticky top-0 flex justify-between items-center"><span className="text-xs font-bold text-zinc-500 pl-2">PISTAS SÓNICAS</span><button className="p-1 hover:bg-zinc-800 rounded text-cyan-500"><i data-lucide="plus"></i></button></div>
                            {tracks.map(track => (
                                <div key={track.id} className="h-24 border-b border-zinc-800 bg-zinc-800/30 p-3 flex flex-col justify-between group hover:bg-zinc-800/50 transition-colors">
                                    <div className="flex items-center gap-2 mb-1">
                                        <div className={`w-3 h-3 rounded-full ${track.color} shadow-[0_0_8px_currentColor]`}></div>
                                        <span className="font-bold text-sm text-zinc-200 tracking-wide">{track.name}</span>
                                    </div>
                                    <div className="flex items-center gap-2 mb-1">
                                        <button onClick={() => toggleMute(track.id)} className={`px-2 py-0.5 text-[10px] font-bold rounded border ${track.muted ? 'bg-red-500/20 text-red-500 border-red-500' : 'bg-zinc-800 text-zinc-500 border-zinc-700'}`}>M</button>
                                        <button onClick={() => toggleSolo(track.id)} className={`px-2 py-0.5 text-[10px] font-bold rounded border ${track.solo ? 'bg-yellow-500/20 text-yellow-500 border-yellow-500' : 'bg-zinc-800 text-zinc-500 border-zinc-700'}`}>S</button>
                                        <div className="flex-1"></div>
                                        <div className="text-[10px] font-mono text-cyan-500">{track.vol}dB</div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <i data-lucide="volume-2"></i>
                                        <input type="range" min="0" max="100" value={track.vol} onChange={(e) => updateVol(track.id, e.target.value)} className="fader-track" />
                                    </div>
                                </div>
                            ))}
                            <div className="flex-1 bg-zinc-900/50"></div>
                        </div>

                        <div className="flex-1 bg-[#0a0a0a] relative overflow-x-auto overflow-y-auto">
                            <div className="h-8 bg-zinc-900 border-b border-zinc-800 sticky top-0 z-10 flex text-[10px] font-mono text-zinc-500 items-end pb-1 pl-4" style={{ minWidth: '1200px' }}>
                                {[...Array(30)].map((_, i) => (<div key={i} className="flex-1 border-l border-zinc-700 h-3 pl-1">{i + 1}</div>))}
                            </div>
                            <div className="relative" style={{ minWidth: '1200px', height: `${tracks.length * 96}px` }}>
                                <div className="absolute inset-0 timeline-grid opacity-20 pointer-events-none"></div>
                                <div className="absolute top-0 bottom-0 w-px bg-red-500 z-30 playhead pointer-events-none" style={{ transform: `translateX(${currentTime}px)` }}>
                                    <div className="w-3 h-3 -ml-1.5 bg-red-500 transform rotate-45 -mt-1.5"></div>
                                </div>
                                {tracks.map((track, index) => (
                                    <div key={track.id} className="h-24 border-b border-zinc-800/50 relative py-2">
                                        <div className="absolute top-1/2 left-0 right-0 h-px bg-zinc-800"></div>
                                        {track.regions.map((region, rIdx) => (
                                            <div key={rIdx} className={`absolute top-2 bottom-2 rounded-md border border-white/10 opacity-90 overflow-hidden ${track.muted ? 'opacity-30 grayscale' : ''} ${track.color}`} style={{ left: `${region.start}px`, width: `${region.width}px` }}>
                                                <div className="absolute inset-0 flex items-center justify-center opacity-30"><div className="w-full h-4 bg-black/50" style={{ clipPath: 'polygon(0 40%, 10% 20%, 20% 80%, 30% 30%, 40% 70%, 50% 40%, 60% 60%, 70% 20%, 80% 80%, 90% 30%, 100% 50%, 100% 100%, 0% 100%)' }}></div></div>
                                                <div className="absolute top-1 left-2 text-[9px] font-bold text-black/70 truncate w-full pr-2">{track.name}_CLIP_{rIdx}</div>
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* 3. FOOTER / STATUS */}
                    <footer className="h-6 bg-zinc-950 border-t border-zinc-800 flex items-center justify-between px-4 text-[10px] text-zinc-600 font-mono">
                        <div>AUDIO_ENGINE: <span className="text-emerald-600">ACTIVE</span> // SYNTH_CORE: <span className="text-cyan-600">PROPRIETARY</span> // LATENCY: {(lookAhead * 1000).toFixed(0)}ms</div>
                        <div className="flex gap-4"><span>STATUS: AWAITING_COMMAND</span> <span className="text-cyan-800">LETRA_DMZ_AUTHORIZED</span></div>
                    </footer>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<OmegaDAW />);
    </script>
</body>
</html>
