<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VOX UMBREA MK-II: SEQUENCER</title>
    <style>
        :root {
            --bg: #050505;
            --panel: #111;
            --border: #333;
            --accent: #00ffcc; /* Cian */
            --beat: #9c4221; /* Terracota */
            --active: #ff0055; /* Magenta */
            --text: #eee;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Courier New', monospace;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- HEADER & CONTROLS --- */
        header {
            padding: 10px;
            border-bottom: 1px solid var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--panel);
        }

        .transport {
            display: flex;
            gap: 10px;
        }

        button {
            background: var(--border);
            color: var(--text);
            border: 1px solid var(--accent);
            padding: 5px 15px;
            font-family: inherit;
            cursor: pointer;
            text-transform: uppercase;
            font-weight: bold;
        }

        button:active, button.playing {
            background: var(--accent);
            color: #000;
        }

        input[type=range] {
            accent-color: var(--accent);
        }

        /* --- MÓDULO 1: SECUENCIADOR (LA LÓGICA) --- */
        #sequencer-module {
            padding: 10px;
            border-bottom: 2px dashed var(--border);
            flex: 0 0 auto;
        }

        .track-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .track-label {
            width: 60px;
            font-size: 0.7rem;
            color: var(--accent);
        }

        .steps {
            display: flex;
            gap: 2px;
            flex: 1;
        }

        .step {
            flex: 1;
            height: 30px;
            background: var(--panel);
            border: 1px solid var(--border);
            cursor: pointer;
        }

        .step.active {
            background: var(--beat);
            box-shadow: 0 0 5px var(--beat);
        }

        .step.current {
            border-color: #fff;
            transform: scale(1.1);
        }

        /* --- MÓDULO 2: DECK DE MEZCLA (LA FUSIÓN) --- */
        #decks-module {
            flex: 1;
            display: flex;
            gap: 10px;
            padding: 10px;
            background: #0a0a0a;
        }

        .deck {
            flex: 1;
            border: 1px solid var(--border);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            border-radius: 5px;
            position: relative;
        }

        .deck h3 { margin: 0; font-size: 0.8rem; color: var(--accent); }

        .file-input {
            font-size: 0.7rem;
            color: #888;
        }

        .deck-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .deck-status {
            height: 5px;
            background: #333;
            width: 0%;
            transition: width 0.1s linear;
        }

        .eq-panel {
            border-top: 1px solid #333;
            padding-top: 5px;
        }

        .eq-label { font-size: 0.6rem; display: block; margin-bottom: 2px; }

        /* CROSSFADER */
        #mixer-control {
            padding: 10px;
            background: var(--panel);
            text-align: center;
        }

        #crossfader { width: 80%; }

    </style>
</head>
<body>

    <header>
        <div class="transport">
            <button id="btnPlay" onclick="togglePlay()">PLAY</button>
            <button onclick="clearPattern()">CLEAR</button>
        </div>
        <div>
            <label style="font-size: 0.7rem;">BPM: <span id="bpmVal">90</span></label>
            <input type="range" min="60" max="140" value="90" oninput="updateBPM(this.value)">
        </div>
    </header>

    <div id="sequencer-module">
        <div style="font-size: 0.7rem; margin-bottom: 5px; color:#666;">// SECUENCIA RÍTMICA (16 PASOS)</div>
        <div class="track-row">
            <div class="track-label">KICK</div>
            <div class="steps" id="track-kick"></div>
        </div>
        <div class="track-row">
            <div class="track-label">SNARE</div>
            <div class="steps" id="track-snare"></div>
        </div>
        <div class="track-row">
            <div class="track-label">HIHAT</div>
            <div class="steps" id="track-hihat"></div>
        </div>
    </div>

    <div id="decks-module">
        <div class="deck" style="border-color: #9c4221;">
            <h3>DECK A: CUMBIA</h3>
            <input type="file" class="file-input" accept="audio/*" onchange="loadAudio(this, 'A')">
            <button onclick="playDeck('A')">PLAY / PAUSE</button>
            <div class="deck-status" id="progress-A"></div>

            <div class="eq-panel">
                <span class="eq-label">FILTRO (LOW PASS) - BAJO</span>
                <input type="range" min="0" max="100" value="100" oninput="updateFilter('A', this.value)">
            </div>
        </div>

        <div class="deck" style="border-color: #00ffcc;">
            <h3>DECK B: HIP HOP</h3>
            <input type="file" class="file-input" accept="audio/*" onchange="loadAudio(this, 'B')">
            <button onclick="playDeck('B')">PLAY / PAUSE</button>
            <div class="deck-status" id="progress-B"></div>

            <div class="eq-panel">
                <span class="eq-label">FILTRO (HIGH PASS) - VOZ</span>
                <input type="range" min="0" max="100" value="0" oninput="updateFilter('B', this.value)">
            </div>
        </div>
    </div>

    <div id="mixer-control">
        <span style="font-size:0.7rem; color:#9c4221">A (CUMBIA)</span>
        <input type="range" id="crossfader" min="0" max="100" value="50" oninput="updateCrossfader(this.value)">
        <span style="font-size:0.7rem; color:#00ffcc">B (RAP)</span>
    </div>

    <script>
        // --- NÚCLEO DE AUDIO ---
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ctx = new AudioContext();

        // --- LÓGICA DEL SECUENCIADOR ---
        let isPlaying = false;
        let currentStep = 0;
        let bpm = 90;
        let nextNoteTime = 0;
        let timerID = null;
        const lookahead = 25.0;
        const scheduleAheadTime = 0.1;

        // Patrones (16 pasos x 3 instrumentos)
        const sequence = {
            kick: new Array(16).fill(false),
            snare: new Array(16).fill(false),
            hihat: new Array(16).fill(false)
        };

        // Inicializar UI del Secuenciador
        ['kick', 'snare', 'hihat'].forEach(track => {
            const container = document.getElementById(`track-${track}`);
            for(let i=0; i<16; i++) {
                const step = document.createElement('div');
                step.className = 'step';
                // Beat Cumbiero por defecto (ejemplo)
                if(track === 'kick' && (i===0 || i===8)) { step.classList.add('active'); sequence.kick[i] = true; }
                if(track === 'hihat' && (i%2!==0)) { step.classList.add('active'); sequence.hihat[i] = true; }

                step.onclick = () => {
                    step.classList.toggle('active');
                    sequence[track][i] = !sequence[track][i];
                };
                step.id = `${track}-${i}`;
                container.appendChild(step);
            }
        });

        function nextNote() {
            const secondsPerBeat = 60.0 / bpm;
            nextNoteTime += 0.25 * secondsPerBeat; // 16th notes
            currentStep = (currentStep + 1) % 16;
        }

        function scheduleNote(beatNumber, time) {
            // UI Feedback
            requestAnimationFrame(() => {
                document.querySelectorAll('.step').forEach(s => s.classList.remove('current'));
                document.getElementById(`kick-${beatNumber}`).classList.add('current');
                document.getElementById(`snare-${beatNumber}`).classList.add('current');
                document.getElementById(`hihat-${beatNumber}`).classList.add('current');
            });

            if(sequence.kick[beatNumber]) playDrum('kick', time);
            if(sequence.snare[beatNumber]) playDrum('snare', time);
            if(sequence.hihat[beatNumber]) playDrum('hihat', time);
        }

        function scheduler() {
            while (nextNoteTime < ctx.currentTime + scheduleAheadTime) {
                scheduleNote(currentStep, nextNoteTime);
                nextNote();
            }
            timerID = window.setTimeout(scheduler, lookahead);
        }

        function togglePlay() {
            if(ctx.state === 'suspended') ctx.resume();
            isPlaying = !isPlaying;
            const btn = document.getElementById('btnPlay');

            if(isPlaying) {
                btn.classList.add('playing');
                btn.innerText = "STOP";
                currentStep = 0;
                nextNoteTime = ctx.currentTime;
                scheduler();
            } else {
                btn.classList.remove('playing');
                btn.innerText = "PLAY";
                window.clearTimeout(timerID);
            }
        }

        function updateBPM(val) {
            bpm = val;
            document.getElementById('bpmVal').innerText = val;
        }

        function clearPattern() {
            ['kick', 'snare', 'hihat'].forEach(track => {
                for (let i = 0; i < 16; i++) {
                    sequence[track][i] = false;
                    const step = document.getElementById(`${track}-${i}`);
                    step.classList.remove('active');
                }
            });
        }

        // --- SINTETIZADOR DE BATERÍA (IGUAL QUE VOX UMBREA 1) ---
        function playDrum(type, time) {
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();

            if(type === 'kick') {
                osc.frequency.setValueAtTime(150, time);
                osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);
                gain.gain.setValueAtTime(1, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + 0.5);
            } else if(type === 'snare') {
                // Snare simplificado para este ejemplo
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(200, time);
                gain.gain.setValueAtTime(0.5, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + 0.2);
            } else {
                // Hihat (Ruido sintético rápido)
                osc.type = 'square'; // Ruido simulado con onda cuadrada muy aguda
                osc.frequency.setValueAtTime(8000, time);
                gain.gain.setValueAtTime(0.3, time);
                gain.gain.exponentialRampToValueAtTime(0.01, time + 0.05);
            }

            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start(time);
            osc.stop(time + 0.5);
        }

        // --- LÓGICA DE DECKS & MEZCLA ---
        const decks = {
            A: { buffer: null, source: null, gain: null, filter: null, playing: false, startOffset: 0, startTime: 0 },
            B: { buffer: null, source: null, gain: null, filter: null, playing: false, startOffset: 0, startTime: 0 }
        };

        // Crear bus de mezcla
        const masterBus = ctx.createGain();
        masterBus.connect(ctx.destination);

        function initDeck(id) {
            decks[id].gain = ctx.createGain();
            decks[id].filter = ctx.createBiquadFilter();

            // Configurar filtros por defecto
            if(id === 'A') { // Cumbia (Low Pass por defecto abierto)
                decks[id].filter.type = 'lowpass';
                decks[id].filter.frequency.value = 20000;
            } else { // Hip Hop (High Pass por defecto cerrado)
                decks[id].filter.type = 'highpass';
                decks[id].filter.frequency.value = 0;
            }

            // Cadena: Source -> Filter -> Gain -> Master
            decks[id].filter.connect(decks[id].gain);
            decks[id].gain.connect(masterBus);
        }

        initDeck('A'); initDeck('B');

        function loadAudio(input, id) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                ctx.decodeAudioData(e.target.result, function(buffer) {
                    decks[id].buffer = buffer;
                    alert(`DECK ${id}: Audio Cargado Exitosamente`);
                });
            };
            reader.readAsArrayBuffer(file);
        }

        function playDeck(id) {
            if (!decks[id].buffer) return;
            if (ctx.state === 'suspended') ctx.resume();

            const deck = decks[id];
            const button = document.querySelector(`.deck[style*="${id === 'A' ? '9c4221' : '00ffcc'}"] button`);

            if (deck.playing) {
                deck.source.stop();
                deck.startOffset = (deck.startOffset + ctx.currentTime - deck.startTime) % deck.buffer.duration;
                deck.playing = false;
                button.classList.remove('playing');
                cancelAnimationFrame(deck.animationFrameId);
            } else {
                const src = ctx.createBufferSource();
                src.buffer = deck.buffer;
                src.loop = true;
                src.connect(deck.filter);

                src.start(0, deck.startOffset);

                deck.source = src;
                deck.startTime = ctx.currentTime;
                deck.playing = true;
                button.classList.add('playing');
                updateProgress(id);
            }
        }

        function updateProgress(id) {
            const deck = decks[id];
            if (deck.playing) {
                const elapsedTime = (deck.startOffset + (ctx.currentTime - deck.startTime)) % deck.buffer.duration;
                const progress = (elapsedTime / deck.buffer.duration) * 100;
                document.getElementById(`progress-${id}`).style.width = `${progress}%`;
                deck.animationFrameId = requestAnimationFrame(() => updateProgress(id));
            }
        }

        function updateFilter(id, val) {
            // Simulación de "Sacar Instrumental/Acapella"
            const freq = (val / 100) * 10000; // Escala hasta 10kHz
            if(id === 'A') {
                // Deck A (Cumbia): Filtro de Bajos. Si bajas, cortas agudos (queda solo bajo).
                decks.A.filter.frequency.value = freq + 50; // Offset para no silenciar todo
            } else {
                // Deck B (Hip Hop): Filtro de Agudos. Si subes, cortas bajos (queda voz/hihats).
                decks.B.filter.frequency.value = freq;
            }
        }

        function updateCrossfader(val) {
            // Mezcla entre A y B (Equal Power Crossfade)
            const x = val / 100;
            // Algoritmo simple linear para ganancia
            decks.A.gain.gain.value = 1 - x;
            decks.B.gain.gain.value = x;
        }

    </script>
</body>
</html>
